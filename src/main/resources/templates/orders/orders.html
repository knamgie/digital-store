<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Заказы</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/app.js}"></script>
</head>

<body>
<div class="nav-bar">
    <a sec:authorize="isAuthenticated()" th:href="@{/users/profile}" class="nav-btn">Профиль</a>
    <a sec:authorize="hasRole('ADMIN')" th:href="@{/users}" class="nav-btn">Пользователи</a>
    <a th:href="@{/products}" class="nav-btn">Товары</a>
    <a th:href="@{/categories}" class="nav-btn">Категории</a>
    <a sec:authorize="isAuthenticated()" th:href="@{/orders}" class="nav-btn">Заказы</a>
    <a th:href="@{/author}" class="nav-btn">Об авторе</a>
</div>

<div class="container">
    <h1>Заказы</h1>

    <div class="logout">
        <form sec:authorize="isAuthenticated()" th:action="@{/logout}" method="post">
            <button type="submit">Выйти</button>
        </form>
        <a sec:authorize="!isAuthenticated()" th:href="@{/login}" style="text-decoration: none;">
            <button type="button">Войти</button>
        </a>
    </div>

    <div class="filter-section" sec:authorize="isAuthenticated()">
        <h2>Поиск и фильтры</h2>
        <form th:action="@{/orders}" method="get" class="filter-form">
            <div class="filter-row">
                <div class="filter-group" sec:authorize="hasAnyRole('MANAGER', 'ADMIN')">
                    <label for="userEmail">Email пользователя</label>
                    <input type="text" id="userEmail" name="userEmail" placeholder="Email" th:value="${param.userEmail}">
                </div>

                <div class="filter-group">
                    <label for="productName">Название товара</label>
                    <input type="text" id="productName" name="productName" placeholder="Товар" th:value="${param.productName}">
                </div>

                <div class="filter-group">
                    <label for="status">Статус</label>
                    <select id="status" name="status">
                        <option value="">Все статусы</option>
                        <option th:each="status : ${statuses}"
                                th:value="${status}"
                                th:text="${status}"
                                th:selected="${param.status == status.name()}"></option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="createdFrom">Создан с</label>
                    <input type="date" id="createdFrom" name="createdFrom" th:value="${param.createdFrom}">
                </div>

                <div class="filter-group">
                    <label for="createdTo">Создан по</label>
                    <input type="date" id="createdTo" name="createdTo" th:value="${param.createdTo}">
                </div>

                <div class="filter-group">
                    <label for="updatedFrom">Изменен с</label>
                    <input type="date" id="updatedFrom" name="updatedFrom" th:value="${param.updatedFrom}">
                </div>

                <div class="filter-group">
                    <label for="updatedTo">Изменен по</label>
                    <input type="date" id="updatedTo" name="updatedTo" th:value="${param.updatedTo}">
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit">Поиск</button>
                <a th:href="@{/orders}" style="text-decoration: none;">
                    <button type="button" class="reset-btn">Сбросить</button>
                </a>
            </div>
        </form>
    </div>

    <div class="stats-section">
        <div class="stat-card">
            <span class="stat-label">Средняя сумма заказа:</span>
            <span class="stat-value" id="avg-order-sum">0.00</span> <span class="currency">руб.</span>
        </div>

        <div class="stat-card">
            <span class="stat-label">Среднее кол-во товаров:</span>
            <span class="stat-value" id="avg-order-qty">0</span>
        </div>

        <div class="stat-card">
            <span class="stat-label">Среднее время доставки:</span>
            <span class="stat-value" id="avg-delivery-time">-</span>
        </div>

        <div class="stat-card">
            <span class="stat-label">Всего заказов:</span>
            <span class="stat-value" id="total-orders">0</span>
        </div>
    </div>

    <div class="table-section">
        <h2>Список заказов</h2>
        <table class="users-table">
            <thead>
            <tr>
                <th class="sortable" data-column="id">ID<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="user">Пользователь<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="product">Товар<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="quantity">Количество<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="price">Цена за ед.<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="totalPrice">Общая сумма<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="status">Статус<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="createdAt">Дата создания<span class="sort-indicator"></span></th>
                <th class="sortable" data-column="updatedAt">Дата изменения<span class="sort-indicator"></span></th>
                <th sec:authorize="isAuthenticated()">Действия</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="order : ${orders}">
                <td th:text="${order.id}"></td>
                <td th:text="${order.userEmail}"></td>

                <td>
                    <span th:text="${order.productName}"></span>
                    <small th:if="${order.productBrand}" th:text="'(' + ${order.productBrand} + ')'"></small>
                </td>

                <td th:text="${order.quantity}"></td>
                <td th:text="${#numbers.formatDecimal(order.unitPrice, 1, 2)}"></td>
                <td th:text="${#numbers.formatDecimal(order.totalPrice, 1, 2)}" style="font-weight: bold;"></td>

                <td>
                    <span th:switch="${order.status.name()}">
                        <span th:case="'NEW'" class="status-new" th:text="${order.status}"></span>
                        <span th:case="'CANCELLED'" class="status-cancelled" th:text="${order.status}"></span>
                        <span th:case="'DELIVERED'" class="status-delivered" th:text="${order.status}"></span>
                        <span th:case="*" class="status-process" th:text="${order.status}"></span>
                    </span>
                </td>

                <td th:text="${#temporals.format(order.createdAt, 'dd.MM.yyyy HH:mm')}"></td>
                <td th:text="${order.updatedAt != null ? #temporals.format(order.updatedAt, 'dd.MM.yyyy HH:mm') : '-'}"></td>

                <td sec:authorize="isAuthenticated()">
                    <form sec:authorize="hasRole('CLIENT')"
                          th:action="@{/orders/{id}/update-status(id=${order.id})}"
                          method="post"
                          style="display: inline;"
                          th:if="${order.status.name() != 'CANCELLED' and order.status.name() != 'DELIVERED'}"
                          class="cancel-order-form"
                          th:attr="data-order-id=${order.id}">
                        <input type="hidden" name="status" value="CANCELLED"/>
                        <button type="submit" class="delete-btn">Отменить заказ</button>
                    </form>

                    <a sec:authorize="hasAnyRole('MANAGER', 'ADMIN')"
                       th:href="@{/orders/{id}/edit-status(id=${order.id})}"
                       class="edit-btn"
                       th:if="${order.status.name() != 'CANCELLED' and order.status.name() != 'DELIVERED'}">
                        Изменить статус
                    </a>

                    <span th:if="${order.status.name() == 'CANCELLED' or order.status.name() == 'DELIVERED'}"
                          style="color: #999; font-style: italic;">
                        -
                    </span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>